<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .link {
        fill: none;
        stroke: #666;
        stroke-width: 1.8px;
    }

    .link.inactive {
        opacity: .2;
    }

    circle {
        fill: #ccc;
        stroke: #333;
        stroke-width: 1.5px;
    }

    .circle.inactive {
        fill: #EDEDED !important;
        stroke: rgb(215, 215, 215);
    }

    .circle.action {
        fill: #cc7e4d;
    }

    .circle.component {
        fill: #5564cc;
    }

    .circle.store {
        fill: #36cc7e;
    }

    text {
        font: 10px sans-serif;
        pointer-events: none;
        text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
    }

    text.inactive {
        opacity: 0;
    }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

    // http://blog.thomsonreuters.com/index.php/mobile-patent-suits-graphic-of-the-day/
    var links = [
        {
            "source": "Todo.Todo.TaskForm",
            "target": "Todo.Todo.TaskCreate",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Todo.Todo.TaskForm",
            "target": "Todo.Todo.TaskUpdate",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Todo.Todo.TaskList",
            "target": "Todo.Todo.TaskCreate",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Todo.Todo.TaskList",
            "target": "Core.UI.AddGrowl",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Todo.Todo.TaskList",
            "target": "Todo.Todo.TaskRestore",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Todo.Todo.TaskList",
            "target": "Todo.Todo.TaskDelete",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Webiny.Layout.Footer",
            "target": "App.ToggleDeveloperMode",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Webiny.Layout.Growler",
            "target": "Core.UI.RemoveGrowl",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Webiny.Layout.Growler",
            "target": "Core.UI.RemoveGrowls",
            "sourceType": "component",
            "targetType": "action"
        },
        {
            "source": "Core.UI.AddGrowl",
            "target": "Core.UI.GrowlsStore",
            "sourceType": "action",
            "targetType": "store"
        },
        {
            "source": "Core.UI.RemoveGrowl",
            "target": "Core.UI.GrowlsStore",
            "sourceType": "action",
            "targetType": "store"
        },
        {
            "source": "Core.UI.RemoveGrowls",
            "target": "Core.UI.GrowlsStore",
            "sourceType": "action",
            "targetType": "store"
        },
        {
            "source": "Core.UI.GrowlsStore",
            "target": "Webiny.Layout.Growler",
            "sourceType": "store",
            "targetType": "component"
        },
        {
            "source": "Todo.Todo.TaskCreate",
            "target": "Todo.Todo.TaskStore",
            "sourceType": "action",
            "targetType": "store"
        },
        {
            "source": "Todo.Todo.TaskDelete",
            "target": "Todo.Todo.TaskStore",
            "sourceType": "action",
            "targetType": "store"
        },
        {
            "source": "Todo.Todo.TaskUpdate",
            "target": "Todo.Todo.TaskStore",
            "sourceType": "action",
            "targetType": "store"
        },
        {
            "source": "Todo.Todo.TaskRestore",
            "target": "Todo.Todo.TaskStore",
            "sourceType": "action",
            "targetType": "store"
        },
        {
            "source": "Todo.Todo.TaskStore",
            "target": "Todo.Todo.TaskList",
            "sourceType": "store",
            "targetType": "component"
        },
        {
            "source": "App.ToggleDeveloperMode",
            "target": "Core.Layout.AppStore",
            "sourceType": "action",
            "targetType": "store"
        },
        {
            "source": "Core.Layout.AppStore",
            "target": "Webiny.Layout.Footer",
            "sourceType": "store",
            "targetType": "component"
        },
        {
            "source": "Core.Layout.AppStore",
            "target": "Webiny.Layout.App",
            "sourceType": "store",
            "targetType": "component"
        }
    ];

    var nodes = {};

    // Compute the distinct nodes from the links.
    links.forEach(function (link) {
        var l = JSON.parse(JSON.stringify(link));
        var nodeSource = nodes[l.source] || {name: l.source, links: [], type: l.sourceType};
        var nodeTarget = nodes[l.target] || {name: l.target, links: [], type: l.targetType};

        nodeSource.links.push(l.target);
        nodes[l.source] = nodeSource;

        nodeTarget.links.push(l.source);
        nodes[l.target] = nodeTarget;

        link.source = nodeSource;
        link.target = nodeTarget;
    });

    var width = document.documentElement.clientWidth - 50;
    var height = document.documentElement.clientHeight - 50;

    var force = d3.layout.force()
            .nodes(d3.values(nodes))
            .links(links)
            .size([width, height])
            .linkDistance(100)
            .charge(-400)
            .on("tick", tick)
            .start();

    var drag = force.drag()
            .origin(function(d) { return d; })
            .on("dragstart", function(){
                d3.event.sourceEvent.stopPropagation();
            });

    var zoom = d3.behavior.zoom()
            .scaleExtent([0.2, 10])
            .on("zoom", zoomed);

    var margin = {top: -5, right: -5, bottom: -5, left: -5};
    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(zoom);

    var container = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.right + ")");

    // Per-type markers, as they don't inherit styles.
    container.append("defs").selectAll("marker")
            .data(["action", "component", "store"])
            .enter().append("marker")
            .attr("id", function (d) {
                return d;
            })
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", function (d) {
                var arrows = {
                    action: 20,
                    component: 20,
                    store: 26
                };
                return arrows[d];
            })
            .attr("refY", -0.5)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5");

    var path = container.append("g").selectAll("path")
            .data(force.links())
            .enter().append("path")
            .attr("class", function (d) {
                return "link " + d.sourceType;
            })
            .attr("marker-end", function (d) {
                return "url(#" + d.targetType + ")";
            });

    var radius = {
        action: 12,
        store: 17,
        component: 10
    };
    var circle = container.append("g").selectAll("circle")
            .data(force.nodes())
            .enter().append("circle")
            .on('mouseover', function (obj) {
                var objName = obj.name;
                circle.classed('inactive', function (d) {
                    if (objName == d.name || obj.links.indexOf(d.name) != -1) {
                        return false;
                    }
                    return true;
                });

                text.classed('inactive', function (d) {
                    if (objName == d.name || obj.links.indexOf(d.name) != -1) {
                        return false;
                    }
                    return true;
                });

                path.classed('inactive', function (d) {
                    if (obj.name == d.source.name || obj.name == d.target.name) {
                        return false;
                    }
                    return true;
                });
            })
            .on('mouseout', function (obj) {
                circle.classed('inactive', false);
                path.classed('inactive', false);
                text.classed('inactive', false);
            })
            .attr("r", function (d) {
                return radius[d.type]
            })
            .attr("class", function (d) {
                return "circle " + d.type
            })
            .call(force.drag)
            .call(drag);


    var text = container.append("g").selectAll("text")
            .data(force.nodes())
            .enter().append("text")
            .attr("x", 8)
            .attr("y", ".31em")
            .text(function (d) {
                return d.name;
            });

    // Use elliptical arc path segments to doubly-encode directionality.
    function tick() {
        path.attr("d", linkArc);
        circle.attr("transform", transform);
        text.attr("transform", transform);
    }

    function linkArc(d) {
        var dx = d.target.x - d.source.x, dy = d.target.y - d.source.y, dr = 0; //Math.sqrt(dx * dx + dy * dy);
        return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
    }

    function transform(d) {
        return "translate(" + d.x + "," + d.y + ")";
    }

    function zoomed() {
        container.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
    }
</script>
</body>
</html>
